---
import Layout from '@/layouts/Layout.astro';
import Footer from '@/components/Footer.astro';
import Header from '@/components/Header.astro';
import { getConvexClient, api } from '@/convex-server';
import SocialActions from '@/components/SocialActions';
import CommentSection from '@/components/CommentSection';
import { Image } from 'astro:assets';

const { slug } = Astro.params;
if (!slug) return Astro.redirect('/404');

const convex = getConvexClient();
const recipe = await convex.query(api.recipes.getBySlug, { slug });

if (!recipe) return Astro.redirect('/404');

export const prerender = false;
---

<Layout title={`${recipe.title} — mise`}>
    <Header variant="minimal" backLink={{ href: '/', label: 'Recipes' }} />

    <main class="pt-20 pb-24">
        <article class="wrapper max-w-4xl">
            <!-- Header -->
            <header class="py-12 md:py-16">
                <span class="tag-sage mb-4 inline-block">{recipe.category || 'Recipe'}</span>
                <h1 class="heading-1 text-3xl sm:text-4xl md:text-5xl mb-4">{recipe.title}</h1>
                {recipe.description && (
                    <p class="body-large max-w-2xl">{recipe.description}</p>
                )}

                <div class="flex flex-wrap items-center gap-4 mt-8 pt-6 border-t border-cream-dark">
                    <a href={`/chef/${recipe.author?.username || recipe.author?.name}`} class="flex items-center gap-3 group">
                        {recipe.author?.image ? (
                            <img src={recipe.author.image} alt={recipe.author.name || 'Author'} class="w-10 h-10 rounded-full object-cover ring-2 ring-cream-dark" />
                        ) : (
                            <div class="w-10 h-10 rounded-full bg-sage/15 flex items-center justify-center text-sage font-medium">
                                {(recipe.author?.name || 'U')[0]}
                            </div>
                        )}
                        <div>
                            <span class="block text-sm font-medium text-charcoal group-hover:text-sage transition-colors">
                                {recipe.author?.name || 'Community Chef'}
                            </span>
                            <span class="block text-xs text-stone">View kitchen →</span>
                        </div>
                    </a>
                    <span class="text-stone-light">·</span>
                    <time class="text-sm text-stone">
                        {new Date(recipe._creationTime).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}
                    </time>
                </div>
            </header>

            <!-- Cover Image -->
            {recipe.coverImageUrl && (
                <div class="rounded-2xl overflow-hidden aspect-video bg-cream-dark mb-12 relative group">
                    <Image 
                        src={recipe.coverImageUrl} 
                        alt={recipe.title} 
                        width={1200} 
                        height={675}
                        class="w-full h-full object-cover" 
                    />
                    {recipe.videoUrl && (
                        <a 
                            href={recipe.videoUrl} 
                            target="_blank" 
                            rel="noopener noreferrer"
                            class="absolute bottom-4 right-4 btn-primary text-sm"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <polygon points="5 3 19 12 5 21 5 3"/>
                            </svg>
                            Watch video
                        </a>
                    )}
                </div>
            )}

            <!-- Content -->
            <div class="grid md:grid-cols-[280px_1fr] gap-8 md:gap-12">
                <!-- Ingredients Sidebar -->
                <aside>
                    <div class="card p-6 sticky top-24">
                        <h3 class="font-serif text-lg font-medium mb-4">Ingredients</h3>
                        <ul class="space-y-3">
                            {recipe.ingredients.map((ing) => (
                                <li class="flex items-start gap-3 text-sm text-charcoal-light">
                                    <span class="w-1.5 h-1.5 rounded-full bg-sage mt-2 shrink-0"></span>
                                    <span>{ing}</span>
                                </li>
                            ))}
                        </ul>
                    </div>
                </aside>

                <!-- Steps -->
                <section>
                    <h3 class="font-serif text-lg font-medium mb-6">Instructions</h3>
                    <ol class="space-y-6">
                        {recipe.steps.map((step, i) => (
                            <li class="flex gap-4">
                                <span class="flex items-center justify-center w-7 h-7 rounded-full bg-charcoal text-cream text-sm font-medium shrink-0">
                                    {i + 1}
                                </span>
                                <p class="text-charcoal-light leading-relaxed pt-0.5">{step}</p>
                            </li>
                        ))}
                    </ol>

                    <div class="mt-12 pt-8 border-t border-cream-dark">
                        <SocialActions 
                            client:idle 
                            recipeId={recipe._id} 
                            initialLiked={recipe.isLiked}
                            initialBookmarked={recipe.isBookmarked} 
                            likesCount={recipe.likesCount} 
                        />
                    </div>

                    <div class="mt-12">
                        <CommentSection client:visible recipeId={recipe._id} isLoggedIn={false} />
                    </div>
                </section>
            </div>
        </article>
    </main>

    <Footer />
</Layout>
